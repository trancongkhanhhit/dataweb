<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B·∫£ng Gi√° S·∫£n Ph·∫©m</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1>üì¶ Danh S√°ch S·∫£n Ph·∫©m</h1>
    
    <div class="button-group">
      <button id="updateBtn" class="btn">üîÑ C·∫≠p nh·∫≠t gi√°</button>
      <a id="downloadBtn" href="{{ url_for('download_excel') }}" class="btn" target="_blank">‚¨áÔ∏è T·∫£i Excel</a>
    </div>

    <div class="progress-container" id="progressContainer" style="display:none;">
      <div class="progress-bar">
        <div id="progress-fill"></div>
      </div>
      <p id="progress-text">ƒêang x·ª≠ l√Ω...</p>
    </div>

    <table id="data-table">
      <thead>
        <tr>
          <th>Model</th>
          <th>Gi√° 1</th>
          <th>Gi√° 2</th>
          <th>Ng√†y c·∫≠p nh·∫≠t</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="4" style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // T·ª± ƒë·ªông detect API base (local ho·∫∑c production)
    const API_BASE = window.location.origin;
    console.log('API Base:', API_BASE);

    function loadData() {
      $.getJSON(`${API_BASE}/data`, function(rows) {
        const tbody = $("#data-table tbody");
        tbody.empty();
        
        if (rows.length === 0) {
          tbody.append('<tr><td colspan="4" style="text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>');
          return;
        }
        
        rows.forEach(r => {
          tbody.append(`
            <tr>
              <td>${r.model || ''}</td>
              <td>${r.price1 || ''}</td>
              <td>${r.price2 || ''}</td>
              <td>${r.date || ''}</td>
            </tr>
          `);
        });
      }).fail(function(err) {
        console.error("L·ªói load data:", err);
        $("#data-table tbody").html('<tr><td colspan="4" style="text-align:center;color:red;">‚ùå L·ªói t·∫£i d·ªØ li·ªáu!</td></tr>');
      });
    }

    $("#updateBtn").on("click", function() {
      if (confirm("B·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t gi√°? Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t.")) {
        $.get(`${API_BASE}/update`, function() {
          $("#progressContainer").show();
          $("#updateBtn").prop("disabled", true).text("‚è≥ ƒêang c·∫≠p nh·∫≠t...");
          checkProgress();
        }).fail(function(err) {
          console.error("L·ªói update:", err);
          alert("‚ùå L·ªói khi b·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t!");
        });
      }
    });

    function checkProgress() {
      const interval = setInterval(function() {
        $.getJSON(`${API_BASE}/progress`, function(data) {
          if (data.percent !== undefined) {
            $("#progress-fill").css("width", data.percent + "%");
            $("#progress-text").text(`${data.status} (${data.percent}%)`);
          } else {
            $("#progress-text").text(data.status || 'ƒêang x·ª≠ l√Ω...');
          }
          
          // Ki·ªÉm tra n·∫øu ho√†n th√†nh
          if (data.status && (data.status.includes("Ho√†n t·∫•t") || data.percent === 100)) {
            clearInterval(interval);
            $("#progress-text").text("‚úÖ Ho√†n t·∫•t! ƒêang t·∫£i l·∫°i d·ªØ li·ªáu...");
            
            setTimeout(function() {
              $("#progressContainer").fadeOut();
              $("#updateBtn").prop("disabled", false).text("üîÑ C·∫≠p nh·∫≠t gi√°");
              loadData();
            }, 2000);
          }
          
          // Ki·ªÉm tra n·∫øu c√≥ l·ªói
          if (data.status && data.status.toLowerCase().includes("error")) {
            clearInterval(interval);
            $("#progress-text").text("‚ùå " + data.status);
            $("#updateBtn").prop("disabled", false).text("üîÑ C·∫≠p nh·∫≠t gi√°");
          }
        }).fail(function() {
          // Kh√¥ng log l·ªói n·∫øu endpoint ch∆∞a s·∫µn s√†ng
        });
      }, 1000);
    }

    // Load data khi trang load
    $(document).ready(function() {
      loadData();
    });
  </script>
</body>
</html>