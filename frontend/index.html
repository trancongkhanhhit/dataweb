<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>B·∫£ng Gi√° S·∫£n Ph·∫©m</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1>üì¶ Danh S√°ch S·∫£n Ph·∫©m</h1>

    <div class="button-group">
      <div class="left">
        <button id="updateBtn" class="btn">üîÑ C√†o l·∫°i gi√°</button>
        <button id="updateWCBtn" class="btn">üí∞ C·∫≠p nh·∫≠t gi√° WooCommerce (Ch·ªçn)</button>
        <a id="downloadBtn" href="{{ url_for('download_excel') }}" class="btn" target="_blank">‚¨áÔ∏è T·∫£i Excel</a>
      </div>
      <div class="right">
        <label><input type="checkbox" id="selectAll"> Ch·ªçn t·∫•t c·∫£</label>
      </div>
    </div>

    <div class="progress-container" id="progressContainer" style="display:none;">
      <div class="progress-bar">
        <div id="progress-fill"></div>
      </div>
      <p id="progress-text">ƒêang x·ª≠ l√Ω...</p>
    </div>

    <table id="data-table">
      <thead>
        <tr>
          <th>SKU</th>
          <th>T√™n / Model</th>
          <th>Gi√° m·ªõi (price1)</th>
          <th>Gi√° c≈© (price-1)</th>
          <th>TƒÉng / Gi·∫£m</th>
          <th>%</th>
          <th>Gi√° c·∫≠p nh·∫≠t web<br/>(c√≥ th·ªÉ ch·ªânh)</th>
          <th>Ng√†y</th>
          <th>Ch·ªçn</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="10" style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
      </tbody>
    </table>
  </div>

<script>
  const API_BASE = window.location.origin;

  function formatPrice(value) {
    if (value === null || value === undefined || value === "") return '';
    let n = parseInt(String(value).replace(/[^\d]/g, '')) || 0;
    return n.toLocaleString('vi-VN') + ' ‚Ç´';
  }

  function loadData() {
    $.getJSON(`${API_BASE}/data`, function(rows) {
      const tbody = $("#data-table tbody");
      tbody.empty();

      if (!rows || rows.length === 0) {
        tbody.append('<tr><td colspan="10" style="text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>');
        return;
      }

      rows.forEach(r => {
        const sku = r.model || '';
        const name = r.name || r.product || '';
        const price1 = r.price1 || r['price1'] || '';
        const price_old = r['price-1'] || r['price-1'] || '';
        const change = r.change || '';
        const percent = r.percent_change || r['percent_change'] || '';
        const update_price = r.update_price || r['update_price'] || '';
        const date = r.date || '';

        const price1_display = formatPrice(price1);
        const price_old_display = formatPrice(price_old);
        const change_display = (change === '' ? '' : formatPrice(change));
        const percent_display = (percent === '' ? '' : `${percent}%`);
        const update_price_display = update_price === '' ? '' : (parseInt(String(update_price).replace(/[^\d]/g,'')) || 0);

        tbody.append(`
          <tr data-sku="${sku}">
            <td class="sku">${sku}</td>
            <td>${name}</td>
            <td class="price1">${price1_display}</td>
            <td class="price-old">${price_old_display}</td>
            <td class="change">${change_display}</td>
            <td class="percent">${percent_display}</td>
            <td class="update-price-cell">
              <input type="number" class="update-price-input" value="${update_price_display}" />
            </td>
            <td class="date">${date}</td>
            <td style="text-align:center;"><input type="checkbox" class="select-sku" /></td>
            <td>
              <button class="save-row btn small">üíæ L∆∞u</button>
            </td>
          </tr>
        `);
      });

      // checkbox h√†nh vi
      $("#selectAll").prop("checked", false);
    }).fail(function(err) {
      console.error("‚ùå L·ªói load data:", err);
      $("#data-table tbody").html('<tr><td colspan="10" style="text-align:center;color:red;">L·ªói t·∫£i d·ªØ li·ªáu!</td></tr>');
    });
  }

  // C√†o l·∫°i gi√°
  $("#updateBtn").on("click", function() {
    if (!confirm("B·∫Øt ƒë·∫ßu c√†o l·∫°i gi√°?")) return;
    $.get(`${API_BASE}/update`, function() {
      $("#progressContainer").show();
      $("#updateBtn").prop("disabled", true).text("‚è≥ ƒêang c·∫≠p nh·∫≠t...");
      checkProgress();
    }).fail(function(err) {
      alert("‚ùå L·ªói khi b·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t!");
    });
  });

  function checkProgress() {
    const interval = setInterval(function() {
      $.getJSON(`${API_BASE}/progress`, function(data) {
        if (data.percent !== undefined) {
          $("#progress-fill").css("width", data.percent + "%");
          $("#progress-text").text(`${data.status} (${data.percent}%)`);
        } else {
          $("#progress-text").text(data.status || 'ƒêang x·ª≠ l√Ω...');
        }

        if (data.status && (data.status.includes("Ho√†n t·∫•t") || data.percent === 100)) {
          clearInterval(interval);
          $("#progress-text").text("‚úÖ Ho√†n t·∫•t! ƒêang t·∫£i l·∫°i d·ªØ li·ªáu...");
          setTimeout(function() {
            $("#progressContainer").fadeOut();
            $("#updateBtn").prop("disabled", false).text("üîÑ C√†o l·∫°i gi√°");
            loadData();
          }, 1500);
        }

        if (data.status && data.status.toLowerCase().includes("error")) {
          clearInterval(interval);
          $("#progress-text").text("‚ùå " + data.status);
          $("#updateBtn").prop("disabled", false).text("üîÑ C√†o l·∫°i gi√°");
        }
      });
    }, 1000);
  }

  // Ch·ªçn t·∫•t c·∫£
  $(document).on("change", "#selectAll", function() {
    const checked = $(this).is(":checked");
    $(".select-sku").prop("checked", checked);
  });

  // Save m·ªôt h√†ng
  $(document).on("click", ".save-row", function() {
    const tr = $(this).closest("tr");
    const sku = tr.data("sku");
    const input = tr.find(".update-price-input");
    const val = parseInt(input.val() || 0);

    $(this).prop("disabled", true).text("‚è≥");

    $.ajax({
      url: `${API_BASE}/save-row`,
      method: "POST",
      contentType: "application/json",
      data: JSON.stringify({ sku: sku, update_price: val })
    }).done(function(res) {
      alert("‚úÖ ƒê√£ l∆∞u update_price cho SKU: " + sku);
      loadData();
    }).fail(function(err) {
      console.error(err);
      alert("‚ùå L·ªói khi l∆∞u");
    }).always(function() {
      $(".save-row").prop("disabled", false).text("üíæ L∆∞u");
    });
  });

  // Bulk update to WooCommerce using input update_price values
  $("#updateWCBtn").on("click", function() {
    const selected = [];
    const price_map = {};

    $("#data-table tbody tr").each(function() {
      const tr = $(this);
      const checkbox = tr.find(".select-sku");
      if (checkbox.is(":checked")) {
        const sku = tr.data("sku");
        const val = parseInt(tr.find(".update-price-input").val() || 0);
        selected.push(sku);
        price_map[sku] = val;
      }
    });

    if (selected.length === 0) {
      alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 s·∫£n ph·∫©m!");
      return;
    }
    if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën c·∫≠p nh·∫≠t ${selected.length} s·∫£n ph·∫©m l√™n WooCommerce?`)) return;

    $("#updateWCBtn").prop("disabled", true).text("‚è≥ ƒêang c·∫≠p nh·∫≠t...");

    fetch(`${API_BASE}/update-prices`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ selected_skus: selected, price_map: price_map })
    }).then(res => res.json())
      .then(result => {
        console.log("KQ c·∫≠p nh·∫≠t:", result);
        alert("‚úÖ Ho√†n t·∫•t c·∫≠p nh·∫≠t WooCommerce (xem console ƒë·ªÉ bi·∫øt chi ti·∫øt).");
        loadData();
      }).catch(err => {
        console.error(err);
        alert("‚ùå L·ªói khi c·∫≠p nh·∫≠t WooCommerce.");
      }).finally(() => {
        $("#updateWCBtn").prop("disabled", false).text("üí∞ C·∫≠p nh·∫≠t gi√° WooCommerce (Ch·ªçn)");
      });
  });

  $(document).ready(function() {
    loadData();
  });
</script>
</body>
</html>
