<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B·∫£ng Gi√° S·∫£n Ph·∫©m</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1>üì¶ Danh S√°ch S·∫£n Ph·∫©m</h1>
    
    <div class="button-group">
      <button id="updateBtn" class="btn">üîÑ C√†o l·∫°i gi√°</button>
      <button id="updateWCBtn" class="btn">üí∞ C·∫≠p nh·∫≠t gi√° WooCommerce</button>
      <a id="downloadBtn" href="{{ url_for('download_excel') }}" class="btn" target="_blank">‚¨áÔ∏è T·∫£i Excel</a>
    </div>

    <div class="progress-container" id="progressContainer" style="display:none;">
      <div class="progress-bar">
        <div id="progress-fill"></div>
      </div>
      <p id="progress-text">ƒêang x·ª≠ l√Ω...</p>
    </div>

    <table id="data-table">
      <thead>
        <tr>
          <th>Ch·ªçn</th>
          <th>M√£ s·∫£n ph·∫©m (SKU)</th>
          <th>T√™n / Model</th>
          <th>Gi√° 1 (price1)</th>
          <th>Gi√° 2 (price2)</th>
          <th>Ng√†y c·∫≠p nh·∫≠t</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="6" style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const API_BASE = window.location.origin;
    console.log('API Base:', API_BASE);

    // --- H√†m ƒë·ªãnh d·∫°ng gi√°: th√™m ph√¢n c√°ch v√† k√Ω hi·ªáu ‚Ç´ ---
    function formatPrice(value) {
      if (!value) return '';
      // lo·∫°i b·ªè k√Ω t·ª± kh√¥ng c·∫ßn thi·∫øt
      let clean = value.toString().replace(/[^\d]/g, '');
      if (!clean) return '';
      return parseInt(clean).toLocaleString('vi-VN') + ' ‚Ç´';
    }

    // --- Load d·ªØ li·ªáu Google Sheet ---
    function loadData() {
      $.getJSON(`${API_BASE}/data`, function(rows) {
        const tbody = $("#data-table tbody");
        tbody.empty();

        if (rows.length === 0) {
          tbody.append('<tr><td colspan="6" style="text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>');
          return;
        }

        rows.forEach(r => {
          const sku = r.model || '';
          const price1 = r.price1 || '';
          const price2 = r.price2 || '';
          const date = r.date || '';
          const name = r.name || r.product || '';

          tbody.append(`
            <tr data-sku="${sku}" data-price="${price1}">
              <td><input type="checkbox" class="select-sku"></td>
              <td>${sku}</td>
              <td>${name}</td>
              <td>${formatPrice(price1)}</td>
              <td>${formatPrice(price2)}</td>
              <td>${date}</td>
            </tr>
          `);
        });
      }).fail(function(err) {
        console.error("‚ùå L·ªói load data:", err);
        $("#data-table tbody").html('<tr><td colspan="6" style="text-align:center;color:red;">L·ªói t·∫£i d·ªØ li·ªáu!</td></tr>');
      });
    }

    // --- C√†o l·∫°i gi√° ---
    $("#updateBtn").on("click", function() {
      if (confirm("B·∫Øt ƒë·∫ßu c√†o l·∫°i gi√°? Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t.")) {
        $.get(`${API_BASE}/update`, function() {
          $("#progressContainer").show();
          $("#updateBtn").prop("disabled", true).text("‚è≥ ƒêang c·∫≠p nh·∫≠t...");
          checkProgress();
        }).fail(function(err) {
          console.error("‚ùå L·ªói update:", err);
          alert("‚ùå L·ªói khi b·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t!");
        });
      }
    });

    // --- Theo d√µi ti·∫øn tr√¨nh c√†o gi√° ---
    function checkProgress() {
      const interval = setInterval(function() {
        $.getJSON(`${API_BASE}/progress`, function(data) {
          if (data.percent !== undefined) {
            $("#progress-fill").css("width", data.percent + "%");
            $("#progress-text").text(`${data.status} (${data.percent}%)`);
          } else {
            $("#progress-text").text(data.status || 'ƒêang x·ª≠ l√Ω...');
          }

          if (data.status && (data.status.includes("Ho√†n t·∫•t") || data.percent === 100)) {
            clearInterval(interval);
            $("#progress-text").text("‚úÖ Ho√†n t·∫•t! ƒêang t·∫£i l·∫°i d·ªØ li·ªáu...");
            setTimeout(function() {
              $("#progressContainer").fadeOut();
              $("#updateBtn").prop("disabled", false).text("üîÑ C√†o l·∫°i gi√°");
              loadData();
            }, 2000);
          }

          if (data.status && data.status.toLowerCase().includes("error")) {
            clearInterval(interval);
            $("#progress-text").text("‚ùå " + data.status);
            $("#updateBtn").prop("disabled", false).text("üîÑ C√†o l·∫°i gi√°");
          }
        });
      }, 1000);
    }

    // --- C·∫≠p nh·∫≠t gi√° WooCommerce ---
    $("#updateWCBtn").on("click", function() {
      const selectedSkus = [];
      const priceMap = {};

      $("#data-table tbody tr").each(function() {
        const checkbox = $(this).find(".select-sku");
        if (checkbox.is(":checked")) {
          const sku = $(this).data("sku");
          const priceText = $(this).data("price").toString().replace(/[^\d]/g, '');
          const price = parseInt(priceText);
          selectedSkus.push(sku);
          priceMap[sku] = price;
        }
      });

      if (selectedSkus.length === 0) {
        alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 s·∫£n ph·∫©m ƒë·ªÉ c·∫≠p nh·∫≠t gi√°!");
        return;
      }

      if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën c·∫≠p nh·∫≠t ${selectedSkus.length} s·∫£n ph·∫©m sang WooCommerce?`)) return;

      $("#updateWCBtn").prop("disabled", true).text("‚è≥ ƒêang c·∫≠p nh·∫≠t WooCommerce...");

      fetch(`${API_BASE}/update-prices`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ selected_skus: selectedSkus, price_map: priceMap })
      })
      .then(res => res.json())
      .then(result => {
        console.log("K·∫øt qu·∫£ c·∫≠p nh·∫≠t:", result);
        alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t gi√° WooCommerce!");
      })
      .catch(err => {
        console.error("‚ùå L·ªói khi c·∫≠p nh·∫≠t WooCommerce:", err);
        alert("‚ùå C√≥ l·ªói khi c·∫≠p nh·∫≠t WooCommerce!");
      })
      .finally(() => {
        $("#updateWCBtn").prop("disabled", false).text("üí∞ C·∫≠p nh·∫≠t gi√° WooCommerce");
      });
    });

    // --- Khi t·∫£i trang ---
    $(document).ready(function() {
      loadData();
    });
  </script>
</body>
</html>
